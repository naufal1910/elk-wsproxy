input {
  file {
    id => "tomcat-access"
    path => ["/tomcat-logs/localhost_access_log*.txt"]
    start_position => "beginning"
    sincedb_path   => "/usr/share/logstash/data/sincedb-tomcat"
    # mode           => "read"
    tags           => ["tomcat", "accesslog"]
  }
}

filter {
  # 1) Parse access log
  grok {
    match => {
      "message" => [
        # Format dengan durasi microseconds + referrer/agent (butuh %D di AccessLogValve)
        '%{IPORHOST:clientip} %{DATA:ident} %{DATA:auth} \[%{HTTPDATE:logtime}\] "%{WORD:verb} %{DATA:request}(?: HTTP/%{NUMBER:httpversion})?" %{NUMBER:response:int} (?:%{NUMBER:bytes:int}|-) %{NUMBER:duration_us:int} "%{DATA:referrer}" "%{DATA:agent}"',
        # Fallback: format combined standar (tanpa durasi)
        '%{IPORHOST:clientip} %{DATA:ident} %{DATA:auth} \[%{HTTPDATE:logtime}\] "%{WORD:verb} %{DATA:request}(?: HTTP/%{NUMBER:httpversion})?" %{NUMBER:response:int} (?:%{NUMBER:bytes:int}|-) "%{DATA:referrer}" "%{DATA:agent}"',
        # Fallback minimal: tanpa referrer/agent (kalau logmu sangat sederhana)
        '%{IPORHOST:clientip} %{DATA:ident} %{DATA:auth} \[%{HTTPDATE:logtime}\] "%{WORD:verb} %{DATA:request}(?: HTTP/%{NUMBER:httpversion})?" %{NUMBER:response:int} (?:%{NUMBER:bytes:int}|-)'
      ]
    }
    tag_on_failure => ["_tomcat_grok_fail"]
  }

  # 2) Set @timestamp dari field waktu log
  date {
    match   => ["logtime", "dd/MMM/yyyy:HH:mm:ss Z"]
    target  => "@timestamp"
    locale  => "en"
  }

  # 3) Normalisasi tipe & field turunan
  mutate {
    convert => { 
      "bytes"       => "integer"
      "response"    => "integer"
      "duration_us" => "integer"
    }
    add_field => { "url.path" => "%{request}" }
    remove_field => [ "logtime" ]
  }

  # 4) Turunkan duration_ms jika ada duration_us
  ruby {
    code => '
      d = event.get("duration_us")
      if d
        event.set("duration_ms", (d.to_f / 1000.0).round)
      end
    '
  }

  # 5) Parse user agent (jika ada)
  if [agent] {
    useragent {
      source => "agent"
      target => "user_agent"
    }
  }
}


output {
  elasticsearch {
    hosts => ["http://es-wsproxy:9200"]
    index => "tomcat-access-%{+YYYY.MM.dd}"
    # user => "elastic"
    # password => "changeme"
  }
  stdout { codec => rubydebug }
}
